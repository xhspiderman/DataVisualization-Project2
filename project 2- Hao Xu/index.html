<!DOCTYPE html>
<html>
	<head>
		<script src="js/taffy.js"></script>
		<script src="js/2digitHSCodes.js"></script>
		<script src="js/4digitHSCodes_bk.js"></script>
		<script src="js/6digitHSCodes.js"></script>
		<script src="multiple-select-master/jquery-1.11.0.min.js"></script>
		<script src="multiple-select-master/jquerymultipleselect.js"></script>
		<link rel="stylesheet" type="text/css" href="multiple-select-master/multiple-select.css">

		<script>
        // Three level HS code
		var HS2 = TAFFY( HS2_code );
		var HS4 = TAFFY( HS4_code );
		var HS6 = TAFFY( HS6_code );
		// when outputing hscode field, 01 will be 1, but when doing matching, we still need 01 to match it !!!!

		</script>
	</head>
	<body>
    <h1>Trading Data</h1>
    
    <!-- display results for selection -->
    <p id="eventResult">Here is the result of event.</p>
    <select multiple="multiple" id='First_Level_Selection' style='width:1100px;'></select>
    <input type="checkbox" id="includeDetail">include detail
    <!-- display results for selected HS6 code -->
    <div id='selected_HS_Code'></div>

    <script>

    // Used to store Selected HS2 code
    var selectedValues = [];
    
    // Used to generate regex expression for HS2
	function regex2gen(number)
	{
        var tempstr = '^'
        var numstr = number.toString()
        for (var i=0;i<numstr.length;i++)
		{ 
			tempstr += '['+numstr[i]+']'
		}
		tempstr += '$'

		return (new RegExp(tempstr))
	}
    //  Used to generate regex expresion for HS4 and HS6 from HS2 and HS4 respectively
		function regexgen(number, digNum)
	{   
		digNum = typeof digNum !== 'undefined' ? digNum : 2;
        var tempstr = '^'
        var numstr = number.toString()
        for (var i=0;i<numstr.length;i++)
		{ 
			tempstr += '['+numstr[i]+']'
		}
		for (var i=0; i<digNum;i++)
		{
			tempstr += '[0-9]'
		}
		tempstr += '$'

		return (new RegExp(tempstr))
	}

	function HS6_Code_Update(){ 
		var selected_HS6_Codes = []
		// includeDetail = document.getElementById("includeDetail").checked
		includeDetail = document.getElementById("includeDetail").checked

		if(includeDetail){// code for detailed selection box
			for (var i in selectedValues){
				// derive HS6 code from HS6 code
				HS6({hs_code:{regex: regexgen(selectedValues[i],0)}}).each(function (record,recordnumber) {
                    selected_HS6_Codes.push({'hs_6': record.hs_code, 'description':record.description})
        		});
			}
		}
		else{// code for no-detail selection box
			for (var i in selectedValues){
        	// derive HS6 code from HS2 code
    		HS6({hs_code:{regex: regexgen(selectedValues[i],4)}}).each(function (record,recordnumber) {
                    selected_HS6_Codes.push({'hs_6': record.hs_code, 'description':record.description})
        		});
	        }
		}
	        // stringiy HS6 matrix and display them
        var x=document.getElementById("selected_HS_Code");
			x.innerHTML= JSON.stringify(selected_HS6_Codes);
			console.log(selected_HS6_Codes.length)
	}

    </script>

    <script>
    // As the starting choosing list
    var firstLevel = [{description:"01-05  Animal &amp; Animal Products",start:1,end:5},
    {description:'06-15  Vegetable Products',start:6,end:15},
    {description:'16-24  Foodstuffs',start:16,end:24},
    {description:'28-38  Chemicals & Allied Industries',start:28,end:38},
    {description:'39-40  Plastics / Rubbers',start:39,end:40},
    {description:'41-43  Raw Hides, Skins, Leather, & Furs',start:41,end:43},
    {description:'44-49  Wood & Wood Products',start:44,end:49},
    {description:'50-63  Textiles',start:50,end:63},
    {description:'64-67  Footwear / Headgear',start:64,end:67},
    {description:'68-71  Stone / Glass',start:68,end:71},
    {description:'72-83  Metals',start:72,end:83},
    {description:'84-85  Machinery / Electrical',start:84,end:85},
    {description:'86-89  Transportation',start:86,end:89},
    {description:'90-97  Miscellaneous',start:90,end:97},
    {description:'98-99  Service',start:98,end:99}]
    function selectionBox(){
    	// Generate the OPTgroup for select section
	    for(var level in firstLevel)
		{  
		    var startOPT = "<optgroup label='"+firstLevel[level].description+"'>"
	        var options = ''
		    for( var i= firstLevel[level].start ; i<= firstLevel[level].end; i++ )
		    	// <option value="1.4">Option 4</option>
		    {   
		    	if( HS2({hs_code:{regex: regex2gen(i)}}).first() ){
		    		var includeDetail = document.getElementById("includeDetail").checked
		    		if(includeDetail){
                            
			        		// derive HS6 code from HS2code
			        		// Here we use temp to cache small array for better performance 
			        		HS6({hs_code:{regex: regexgen(i, 4)}}).each(function (record,recordnumber) {
			                    // selected_HS6_Codes.push({'hs_6': record.hs_code, 'description':record.description})
			                    options = options + "<option value='" + record.hs_code +"'>"+record.hs_code+" : "+record.description+"</option> \n"
			        		});
	                    
		    		}
		    		else{
		    			options = options + "<option value='" + i +"'>"+      HS2({hs_code:{regex: regex2gen(i)}}).first().description     +"</option> \n"
		    		}		            
		        }
		    }
		    var endOPT = "</optgroup>"
		   $(startOPT + options + endOPT).appendTo('#First_Level_Selection');
		}

    }
    selectionBox()
    </script>
    <script>
    
    function selectBoxInitialization(){
		    //  Initialize the multi-selector
	        $("select").multipleSelect({
	        	filter: true,
	            multiple: true,
	            multipleWidth: 1000,

	            //Selection API, uncomment to use

	            // onOpen: function() {
	            //     // $('#eventResult').text('Select opened!');
	            //     selectionUpdate()
	            // },
	            // onClose: function() {
	            //     // $('#eventResult').text('Select closed!');
	            //     selectionUpdate()
	            // },
	            onCheckAll: function() {
	                // $('#eventResult').text('Check all clicked!');
	                selectionUpdate()
	            },
	            onUncheckAll: function() {
	                // $('#eventResult').text('Uncheck all clicked!');
	                selectionUpdate()
	            },
	            onOptgroupClick: function(view) {
	                // var values = $.map(view.children, function(child){
	                //     return child.value;
	                // }).join(', ');
	                // $('#eventResult').text('Optgroup ' + view.label + ' ' + 
	                //     (view.checked ? 'checked' : 'unchecked') + ': ' + values);
	                selectionUpdate()
	            },
	            onClick: function(view) {
	                // $('#eventResult').text(view.label + '(' + view.value + ') ' + 
	                //     (view.checked ? 'checked' : 'unchecked'));
	                selectionUpdate()
	            }
	        });
    }
    selectBoxInitialization();
        
        // collect selected datas
         function selectionUpdate() {

            selectedValues = $("select").multipleSelect("getSelects");
            var selectedTexts = $("select").multipleSelect("getSelects", "text");
            $('#eventResult').html(selectedValues)
            HS6_Code_Update()
        };

        $( document ).ready(function() {
		    $("#includeDetail").click(function(){
		    	// $( "#First_Level_Selection" ).unbind();
		    	$("#First_Level_Selection").html("");
                selectionBox();
                selectBoxInitialization();
		    });
		});

    </script>

	</body>
				
</html>